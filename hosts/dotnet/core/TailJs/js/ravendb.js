import{transformLocalIds as e}from"@tailjs/types";var t,i,s=void 0,r=(t=e=>"string"==typeof e,i=e=>(e=>null!=e)(e)?""+e:e,(e,r=!0)=>t(e)||i&&r&&(e=>e!==s)(e=i(e))?e:s),n="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},o={},a={};!function(e){var t=n&&n.__awaiter||function(e,t,i,s){return new(i||(i=Promise))((function(r,n){function o(e){try{u(s.next(e))}catch(e){n(e)}}function a(e){try{u(s.throw(e))}catch(e){n(e)}}function u(e){e.done?r(e.value):new i((function(t){t(e.value)})).then(o,a)}u((s=s.apply(e,t||[])).next())}))},i=n&&n.__generator||function(e,t){var i,s,r,n={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return{next:o(0),throw:o(1),return:o(2)};function o(o){return function(a){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;n;)try{if(i=1,s&&(r=s[2&o[0]?"return":o[0]?"throw":"next"])&&!(r=r.call(s,o[1])).done)return r;switch(s=0,r&&(o=[0,r.value]),o[0]){case 0:case 1:r=o;break;case 4:return n.label++,{value:o[1],done:!1};case 5:n.label++,s=o[1],o=[0];continue;case 7:o=n.ops.pop(),n.trys.pop();continue;default:if(!((r=(r=n.trys).length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){n=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){n.label=o[1];break}if(6===o[0]&&n.label<r[1]){n.label=r[1],r=o;break}if(r&&n.label<r[2]){n.label=r[2],n.ops.push(o);break}r[2]&&n.ops.pop(),n.trys.pop();continue}o=t.call(e,n)}catch(e){o=[6,e],s=0}finally{i=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}};e.__esModule=!0;var s=function(){function e(e){this.promiseResolverQueue=[],this.permits=e}return e.prototype.getPermits=function(){return this.permits},e.prototype.wait=function(){return t(this,void 0,void 0,(function(){var e=this;return i(this,(function(t){return this.permits>0?(this.permits-=1,[2,Promise.resolve(!0)]):[2,new Promise((function(t){return e.promiseResolverQueue.push(t)}))]}))}))},e.prototype.acquire=function(){return t(this,void 0,void 0,(function(){return i(this,(function(e){return[2,this.wait()]}))}))},e.prototype.waitFor=function(e){return t(this,void 0,void 0,(function(){var t,s,r=this;return i(this,(function(i){return this.permits>0?(this.permits-=1,[2,Promise.resolve(!0)]):(t=function(e){},s=new Promise((function(e){t=e})),this.promiseResolverQueue.push(t),setTimeout((function(){var e=r.promiseResolverQueue.indexOf(t);-1!==e&&r.promiseResolverQueue.splice(e,1),t(!1)}),e),[2,s])}))}))},e.prototype.tryAcquire=function(){return this.permits>0&&(this.permits-=1,!0)},e.prototype.drainPermits=function(){if(this.permits>0){var e=this.permits;return this.permits=0,e}return 0},e.prototype.signal=function(){if(this.permits+=1,this.permits>1&&this.promiseResolverQueue.length>0)throw new Error("this.permits should never be > 0 when there is someone waiting.");if(1===this.permits&&this.promiseResolverQueue.length>0){this.permits-=1;var e=this.promiseResolverQueue.shift();e&&e(!0)}},e.prototype.release=function(){this.signal()},e.prototype.execute=function(e){return t(this,void 0,void 0,(function(){return i(this,(function(t){switch(t.label){case 0:return[4,this.wait()];case 1:t.sent(),t.label=2;case 2:return t.trys.push([2,,4,5]),[4,e()];case 3:return[2,t.sent()];case 4:return this.signal(),[7];case 5:return[2]}}))}))},e}();e.default=s}(a);var u,c={},l=n&&n.__extends||(u=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},function(e,t){function i(){this.constructor=e}u(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)});c.__esModule=!0;var h=function(e){function t(){return e.call(this,1)||this}return l(t,e),t}(a.default);c.Lock=h,function(e){e.__esModule=!0;var t=a;e.default=t.default,function(t){for(var i in t)e.hasOwnProperty(i)||(e[i]=t[i])}(c)}(o);var d=Object.defineProperty,p=Object.defineProperties,f=Object.getOwnPropertyDescriptors,v=Object.getOwnPropertySymbols,_=Object.prototype.hasOwnProperty,y=Object.prototype.propertyIsEnumerable,g=(e,t,i)=>t in e?d(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,b=(e,t)=>{for(var i in t||(t={}))_.call(t,i)&&g(e,i,t[i]);if(v)for(var i of v(t))y.call(t,i)&&g(e,i,t[i]);return e};class w{constructor(e){this.id="ravendb",this._nextId=0,this._idIndex=1,this._idRangeMax=0,this._idBatchSize=1e3,this._settings=e,this._lock=new o.Lock}async initialize(e){var t;try{if(this._env=e,this._settings.x509){var i="cert"in this._settings.x509?this._settings.x509.cert:await this._env.read(this._settings.x509.certPath),s="keyPath"in this._settings.x509?null!=(t=await this._env.readText(this._settings.x509.keyPath))?t:void 0:this._settings.x509.key;if(!i)throw new Error("Certificate not found.");this._cert={id:this.id,cert:i,key:s}}}catch(t){e.log({group:this.id,level:"error",source:`${this.id}:initialize`,data:""+t})}}async post(t,i,s){var n,o,a,u,c;try{var l=[],h=r(null==(n=i.vars.rd_s)?void 0:n.value),d=r(null==(o=i.vars.rd_d)?void 0:o.value),v=r(null==(a=i.vars.rd_ds)?void 0:a.value);for(var _ of(i.vars.rd_s={scope:"session",essential:!0,critical:!0,value:null!=h?h:h=(await this._getNextId()).toString(36)},i.vars.rd_d={scope:"device",essential:!0,critical:!0,value:null!=d?d:d=(await this._getNextId()).toString(36)},i.vars.rd_ds={scope:"device-session",essential:!0,critical:!0,value:null!=v?v:v=(await this._getNextId()).toString(36)},t)){_["rdb:timestamp"]=Date.now(),_=e(_,(e=>`${h}/${e}`));var y=(await this._getNextId()).toString(36);null==_.id&&(_.id=`${y}`),_.session&&(_.session["rdb:deviceId"]=_.session.deviceId,_.session["rdb:sessionId"]=_.session.sessionId,_.session["rdb:deviceSessionId"]=_.session.deviceSessionId,_.session.deviceId=d,_.session.sessionId=h,_.session.deviceSessionId=v),l.push({Type:"PUT",Id:`events/${y}`,Document:(u=b({},_),c={"@metadata":{"@collection":"events"}},p(u,f(c)))})}await this._env.request({method:"POST",url:`${this._settings.url}/databases/${encodeURIComponent(this._settings.database)}/bulk_docs`,headers:{"content-type":"application/json"},x509:this._cert,body:JSON.stringify({Commands:l})})}catch(e){s.log({group:this.id,level:"error",source:`${this.id}:post`,data:""+e})}}async _getNextId(){var e=++this._nextId;if(e>=this._idRangeMax){await this._lock.wait();try{if((e=++this._nextId)>=this._idRangeMax){for(var t=this._idRangeMax+this._idBatchSize,i=0;i<=100;i++){var s=(await this._env.request({method:"PUT",url:`${this._settings.url}/databases/${encodeURIComponent(this._settings.database)}/cmpxchg?key=NextEventId&index=${this._idIndex}`,headers:{"content-type":"application/json"},body:JSON.stringify({Object:t}),x509:this._cert})).body,r=JSON.parse(s),n=r.Successful;if("boolean"!=typeof n)throw new Error(`Unexpected response: ${s}`);var o=r.Index,a=r.Value.Object;if(this._idIndex=o,n){this._idRangeMax=a,this._nextId=this._idRangeMax-this._idBatchSize-1;break}if(i>=10)throw new Error(`Unable to allocate event IDs. Current counter is ${a}@${o}`);t=a+this._idBatchSize,this._env.log({group:this.id,level:"debug",source:"ids",data:`The server reported the next global ID to be ${a}. Retrying with next ID ${t}.`})}e=++this._nextId}}catch(e){this._env.log({group:this.id,level:"error",source:this.id,data:""+e})}finally{this._lock.release()}}return e}}export{w as RavenDbTracker};
