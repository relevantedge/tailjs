import{transformLocalIds}from"@tailjs/types";var typeTester,parser,toString=(typeTester=value=>"string"==typeof value,parser=value=>(value=>null!=value)(value)?""+value:value,(value,parse=!0)=>typeTester(value)||parser&&parse&&(value=>!(value=>void 0===value)(value))(value=parser(value))?value:void 0),commonjsGlobal="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},dist={},Semaphore={};!function(exports){var __awaiter=commonjsGlobal&&commonjsGlobal.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P((function(resolve){resolve(result.value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))},__generator=commonjsGlobal&&commonjsGlobal.__generator||function(thisArg,body){var f,y,t,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return{next:verb(0),throw:verb(1),return:verb(2)};function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=y[2&op[0]?"return":op[0]?"throw":"next"])&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[0,t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!((t=(t=_.trys).length>0&&t[t.length-1])||6!==op[0]&&2!==op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};exports.__esModule=!0;var Semaphore=function(){function Semaphore(permits){this.promiseResolverQueue=[],this.permits=permits}return Semaphore.prototype.getPermits=function(){return this.permits},Semaphore.prototype.wait=function(){return __awaiter(this,void 0,void 0,(function(){var _this=this;return __generator(this,(function(_a){return this.permits>0?(this.permits-=1,[2,Promise.resolve(!0)]):[2,new Promise((function(resolver){return _this.promiseResolverQueue.push(resolver)}))]}))}))},Semaphore.prototype.acquire=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(_a){return[2,this.wait()]}))}))},Semaphore.prototype.waitFor=function(milliseconds){return __awaiter(this,void 0,void 0,(function(){var resolver,promise,_this=this;return __generator(this,(function(_a){return this.permits>0?(this.permits-=1,[2,Promise.resolve(!0)]):(resolver=function(b){},promise=new Promise((function(r){resolver=r})),this.promiseResolverQueue.push(resolver),setTimeout((function(){var index=_this.promiseResolverQueue.indexOf(resolver);-1!==index&&_this.promiseResolverQueue.splice(index,1),resolver(!1)}),milliseconds),[2,promise])}))}))},Semaphore.prototype.tryAcquire=function(){return this.permits>0&&(this.permits-=1,!0)},Semaphore.prototype.drainPermits=function(){if(this.permits>0){var permitCount=this.permits;return this.permits=0,permitCount}return 0},Semaphore.prototype.signal=function(){if(this.permits+=1,this.permits>1&&this.promiseResolverQueue.length>0)throw new Error("this.permits should never be > 0 when there is someone waiting.");if(1===this.permits&&this.promiseResolverQueue.length>0){this.permits-=1;var nextResolver=this.promiseResolverQueue.shift();nextResolver&&nextResolver(!0)}},Semaphore.prototype.release=function(){this.signal()},Semaphore.prototype.execute=function(func){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(_a){switch(_a.label){case 0:return[4,this.wait()];case 1:_a.sent(),_a.label=2;case 2:return _a.trys.push([2,,4,5]),[4,func()];case 3:return[2,_a.sent()];case 4:return this.signal(),[7];case 5:return[2]}}))}))},Semaphore}();exports.default=Semaphore}(Semaphore);var extendStatics,Lock$1={},__extends=commonjsGlobal&&commonjsGlobal.__extends||(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Lock$1.__esModule=!0;var Lock=function(_super){function Lock(){return _super.call(this,1)||this}return __extends(Lock,_super),Lock}(Semaphore.default);Lock$1.Lock=Lock,function(exports){exports.__esModule=!0;var Semaphore_1=Semaphore;exports.default=Semaphore_1.default,function(m){for(var p in m)exports.hasOwnProperty(p)||(exports[p]=m[p])}(Lock$1)}(dist);var __defProp=Object.defineProperty,__defProps=Object.defineProperties,__getOwnPropDescs=Object.getOwnPropertyDescriptors,__getOwnPropSymbols=Object.getOwnPropertySymbols,__hasOwnProp=Object.prototype.hasOwnProperty,__propIsEnum=Object.prototype.propertyIsEnumerable,__defNormalProp=(obj,key,value)=>key in obj?__defProp(obj,key,{enumerable:!0,configurable:!0,writable:!0,value:value}):obj[key]=value,__spreadValues=(a,b)=>{for(var prop in b||(b={}))__hasOwnProp.call(b,prop)&&__defNormalProp(a,prop,b[prop]);if(__getOwnPropSymbols)for(var prop of __getOwnPropSymbols(b))__propIsEnum.call(b,prop)&&__defNormalProp(a,prop,b[prop]);return a};class RavenDbTracker{constructor(settings){this.name="ravendb",this._nextId=0,this._idIndex=1,this._idRangeMax=0,this._idBatchSize=1e3,this._settings=settings,this._lock=new dist.Lock}async initialize(env){var _a;try{if(this._env=env,this._settings.x509){var cert="cert"in this._settings.x509?this._settings.x509.cert:await this._env.read(this._settings.x509.certPath),key="keyPath"in this._settings.x509?null!=(_a=await this._env.readText(this._settings.x509.keyPath))?_a:void 0:this._settings.x509.key;if(!cert)throw new Error("Certificate not found.");this._cert={id:this.name,cert:cert,key:key}}}catch(e){env.log({group:this.name,level:"error",source:`${this.name}:initialize`,data:""+e})}}async post(events,tracker,env){var _a,_b,_c,a,b;try{var commands=[],sessionId=toString(null==(_a=tracker.vars.rd_s)?void 0:_a.value),deviceId=toString(null==(_b=tracker.vars.rd_d)?void 0:_b.value),deviceSessionId=toString(null==(_c=tracker.vars.rd_ds)?void 0:_c.value);for(var ev of(tracker.vars.rd_s={scope:"session",essential:!0,critical:!0,value:null!=sessionId?sessionId:sessionId=(await this._getNextId()).toString(36)},tracker.vars.rd_d={scope:"device",essential:!0,critical:!0,value:null!=deviceId?deviceId:deviceId=(await this._getNextId()).toString(36)},tracker.vars.rd_ds={scope:"device-session",essential:!0,critical:!0,value:null!=deviceSessionId?deviceSessionId:deviceSessionId=(await this._getNextId()).toString(36)},events)){ev["rdb:timestamp"]=Date.now(),ev=transformLocalIds(ev,(id=>`${sessionId}/${id}`));var internalEventId=(await this._getNextId()).toString(36);null==ev.id&&(ev.id=`${internalEventId}`),ev.session&&(ev.session["rdb:deviceId"]=ev.session.deviceId,ev.session["rdb:sessionId"]=ev.session.sessionId,ev.session["rdb:deviceSessionId"]=ev.session.deviceSessionId,ev.session.deviceId=deviceId,ev.session.sessionId=sessionId,ev.session.deviceSessionId=deviceSessionId),commands.push({Type:"PUT",Id:`events/${internalEventId}`,Document:(a=__spreadValues({},ev),b={"@metadata":{"@collection":"events"}},__defProps(a,__getOwnPropDescs(b)))})}await this._env.request({method:"POST",url:`${this._settings.url}/databases/${encodeURIComponent(this._settings.database)}/bulk_docs`,headers:{"content-type":"application/json"},x509:this._cert,body:JSON.stringify({Commands:commands})})}catch(e){env.log({group:this.name,level:"error",source:`${this.name}:post`,data:""+e})}}async _getNextId(){var id=++this._nextId;if(id>=this._idRangeMax){await this._lock.wait();try{if((id=++this._nextId)>=this._idRangeMax){for(var idMax=this._idRangeMax+this._idBatchSize,i=0;i<=100;i++){var response=(await this._env.request({method:"PUT",url:`${this._settings.url}/databases/${encodeURIComponent(this._settings.database)}/cmpxchg?key=NextEventId&index=${this._idIndex}`,headers:{"content-type":"application/json"},body:JSON.stringify({Object:idMax}),x509:this._cert})).body,result=JSON.parse(response),success=result.Successful;if("boolean"!=typeof success)throw new Error(`Unexpected response: ${response}`);var index=result.Index,value=result.Value.Object;if(this._idIndex=index,success){this._idRangeMax=value,this._nextId=this._idRangeMax-this._idBatchSize-1;break}if(i>=10)throw new Error(`Unable to allocate event IDs. Current counter is ${value}@${index}`);idMax=value+this._idBatchSize,this._env.log({group:this.name,level:"debug",source:"ids",data:`The server reported the next global ID to be ${value}. Retrying with next ID ${idMax}.`})}id=++this._nextId}}catch(e){this._env.log({group:this.name,level:"error",source:this.name,data:""+e})}finally{this._lock.release()}}return id}}export{RavenDbTracker};
