{"version":3,"file":"shared-state.js","sourceRoot":"","sources":["shared-state.ts"],"names":[],"mappings":"AAAA,OAAO,EACL,kBAAkB,EAClB,CAAC,EACD,CAAC,EACD,aAAa,EACb,OAAO,EACP,GAAG,EACH,QAAQ,EACR,WAAW,EACX,MAAM,EACN,sBAAsB,EACtB,OAAO,GACR,MAAM,GAAG,CAAC;AAEX,MAAM,kBAAkB,GAAG,aAAa,CAAkC,IAAI,CAAC,CAAC;AAChF,MAAM,oBAAoB,GACxB,EAAE,CAAC;AAEL,MAAM,CAAC,SAAS,EAAE,aAAa,CAAC,GAAG,QAAQ,CAAC,IAAI,CAAC,CAAC;AAElD,OAAO,EAAE,SAAS,IAAI,8BAA8B,EAAE,CAAC;AAEvD,MAAM,CAAC,IAAI,mBAAmB,GAAG,CAAC,CAAC;AACnC,MAAM,cAAc,GAAG,OAAO,EAAE,CAAC;AAEjC,MAAM,CAAC,MAAM,uBAAuB,GAAG,GAAG,EAAE,CAAC,CAAC,cAAc,CAAC,MAAM,EAAE,EAAE,CAAC,CAAC,CAAC;AAE1E,MAAM,CAAC,MAAM,mBAAmB,GAAG,CACjC,GAAW,EACX,OAAgB,EAChB,KAAqC,EACR,EAAE,CAAC,CAChC,oBAAoB,CAAC,GAAG,CAAC;IACvB,CAAC,CAAC,GAAG,CAAC,kBAAkB,EAAE,GAAG,CAAC;IAC9B,CAAC,CAAC,CAAC,oBAAoB,CAAC,GAAG,CAAC,GAAG,CAAC,OAAO,EAAE,KAAK,CAAC,CAAC;IAClD,CAAC,KAAK,EAAE,EAAE,CAAC,kBAAkB,CAAC,EAAE,CAAC,GAAG,CAAC,EAAE,KAAK,EAAE,CAAC,CAChD,CAAC;AAEF,sBAAsB,CAAC,GAAG,EAAE;IAC1B,cAAc,CAAC,GAAG,EAAE,CAAC,CAAC,CAAC,mBAAmB,GAAG,CAAC,CAAC,EAAE,aAAa,EAAE,CAAC,EAAE,EAAE,CAAC,CAAC;IACvE,IAAI,WAAW,GAAG,CAAC,CAAC;IACpB,kBAAkB,CAAC,CAAC,OAAO,EAAE,MAAM,EAAE,EAAE,CACrC,OAAO,KAAK,CAAC,CAAC,UAAU;QACtB,CAAC,CAAC,kBAAkB,CAAC,CAAC,EAAE,MAAM,CAAC,CAAC,cAAc;QAC9C,CAAC,CAAC,OAAO,KAAK,CAAC;YACf,CAAC,CAAC,qBAAqB;gBACrB,CAAC,WAAW,KAAK,CAAC,WAAW,GAAG,CAAC,CAAC,IAAI,kBAAkB,CAAC,CAAC,EAAE,MAAM,CAAC,EAAE,CAAC,CAAC;YACzE,CAAC,CAAC,sCAAsC;gBACxC,OAAO,KAAK,CAAC;oBACb,CAAC,CAAC,kBAAkB,CAChB,WAAW,CACT,OAAO,CAAC,oBAAoB,EAAE,CAAC,CAAC,GAAG,EAAE,CAAC,OAAO,CAAC,CAAC,EAAE,EAAE,CAAC;wBAClD,GAAG;wBACH,OAAO,EAAE;qBACV,CAAC,CACH,EACD,MAAM,CACP;oBACH,CAAC,CAAC,cAAc;wBACd,CAAC,OAAO,CAAC,oBAAoB,EAAE,CAAC,CAAC,GAAG,EAAE,CAAC,EAAE,KAAK,CAAC,CAAC,EAAE,EAAE,CAClD,KAAK,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC,CACpB;4BACD,cAAc,CAAC,MAAM,EAAE,CAAC,CAC7B,CAAC;IACF,iBAAiB;IACjB,kBAAkB,CAAC,CAAC,CAAC,CAAC;IAEtB,MAAM,CAAC,MAAM,EAAE,UAAU,EAAE,GAAG,EAAE,CAAC,CAAC,WAAW,IAAI,kBAAkB,CAAC,CAAC,CAAC,CAAC,CAAC;IACxE,MAAM,CAAC,MAAM,EAAE,UAAU,EAAE,GAAG,EAAE,CAAC,CAAC,WAAW,GAAG,CAAC,CAAC,CAAC,CAAC;AACtD,CAAC,CAAC,CAAC","sourcesContent":["import {\n  ERR_DUPPLICATE_KEY,\n  F,\n  T,\n  createChannel,\n  entries,\n  err,\n  eventSet,\n  fromEntries,\n  listen,\n  registerStartupHandler,\n  timeout,\n} from \".\";\n\nconst globalStateChannel = createChannel<1 | 2 | 3 | Record<string, any>>(\"ss\");\nconst globalStateResolvers: Record<string, [() => any, (value: any) => void]> =\n  {};\n\nconst [listeners, callListeners] = eventSet(true);\n\nexport { listeners as addGlobalStateResolvedListener };\n\nexport let globalStateResolved = F;\nconst resolveTimeout = timeout();\n\nexport const abortGlobalStateResolve = () => (resolveTimeout.finish(), T);\n\nexport const registerSharedState = <T>(\n  key: string,\n  resolve: () => T,\n  apply: (value: T | undefined) => void\n): ((updatedValue: T) => void) => (\n  globalStateResolvers[key]\n    ? err(ERR_DUPPLICATE_KEY, key)\n    : (globalStateResolvers[key] = [resolve, apply]),\n  (value) => globalStateChannel({ [key]: value })\n);\n\nregisterStartupHandler(() => {\n  resolveTimeout(() => ((globalStateResolved = T), callListeners()), 75);\n  let hasResponse = F;\n  globalStateChannel((payload, source) =>\n    payload === 1 // Ask out\n      ? globalStateChannel(2, source) // Offer state\n      : payload === 2\n      ? // Accept state once.\n        (hasResponse !== (hasResponse = T) && globalStateChannel(3, source), T)\n      : // We got picked for sharing the state\n      payload === 3\n      ? globalStateChannel(\n          fromEntries(\n            entries(globalStateResolvers, ([key, [resolve]]) => [\n              key,\n              resolve(),\n            ])\n          ),\n          source\n        )\n      : // Apply state\n        (entries(globalStateResolvers, ([key, [, apply]]) =>\n          apply(payload[key])\n        ),\n        resolveTimeout.finish())\n  );\n  // Ping on wakeup\n  globalStateChannel(1);\n\n  listen(window, \"pageshow\", () => !hasResponse && globalStateChannel(1));\n  listen(window, \"pagehide\", () => (hasResponse = F));\n});\n"]}