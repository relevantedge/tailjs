{"version":3,"file":"userInteraction.js","sourceRoot":"","sources":["userInteraction.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  AnchorNavigationEvent,\n  CartUpdatedEvent,\n  ComponentClickEvent,\n  ConfiguredComponent,\n  NavigationEvent,\n  UserInteractionEvent,\n  cast,\n  isViewEndedEvent,\n} from \"@tailjs/types\";\nimport {\n  TrackerExtensionFactory,\n  getComponentContext,\n  onFrame,\n  pushNavigationSource,\n  tryGetCartEventData,\n} from \"..\";\n\nimport { CONTEXT_MENU_COOKIE } from \"@constants\";\nimport type { Nullish } from \"@tailjs/util\";\nimport { parseActivationTags } from \"..\";\nimport {\n  F,\n  MNT_URL,\n  T,\n  any,\n  attr,\n  attrl,\n  clear,\n  cookies,\n  del,\n  document,\n  encode,\n  equals,\n  forAncestorsOrSelf,\n  getBoundaryData,\n  getScreenPos,\n  getViewport,\n  isInternalUrl,\n  keys,\n  listen,\n  location,\n  map,\n  mapUrl,\n  matchExHash,\n  navigator,\n  nextId,\n  nil,\n  noopAction,\n  obj,\n  parseDomain,\n  push,\n  registerViewEndAction,\n  tagName,\n  timeout,\n  trackerConfig,\n  trackerFlag,\n  tryCatch,\n  window,\n} from \"../lib\";\n\nconst isLinkElement = (\n  el: Element,\n  href: any = tagName(el) === \"A\" && attr(el, \"href\")\n): el is HTMLAnchorElement =>\n  href && href != \"#\" && !href.startsWith(\"javascript:\");\n\nconst isClickable = (\n  el: Element,\n  t = tagName(el),\n  attr = trackerFlag(el, \"button\")\n): el is HTMLElement =>\n  attr !== F &&\n  (equals(t, \"A\", \"BUTTON\") ||\n    (t === \"INPUT\" && equals(attrl(el, \"type\"), \"button\", \"submit\")) ||\n    attr === T);\n\nfunction getElementLabel(el: Element | EventTarget | null, container: Element) {\n  let info: Pick<UserInteractionEvent, \"element\"> | undefined;\n  forAncestorsOrSelf(el ?? container, (el) =>\n    equals(tagName(el), \"IMG\") || el === container\n      ? ((info = {\n          element: {\n            tagName: el.tagName,\n            text:\n              attr(el, \"title\") ||\n              attr(el, \"alt\") ||\n              (el as HTMLElement).innerText?.trim().substring(0, 100) ||\n              undefined,\n          },\n        }),\n        F)\n      : T\n  );\n  return info;\n}\nexport const userInteraction: TrackerExtensionFactory = {\n  id: \"navigation\",\n\n  setup(tracker) {\n    const pollContextCookie = timeout();\n\n    // There can be all kinds of fishy navigation logic happening, so it is not enough just to look at link (<A>) clicks.\n    // Hence, when navigation occurs (in the current tab), we do not send the event before we have an VIEW_END.\n    // We rely on that the logic for VIEW_END takes care all the different ways to navigate (history.push etc.) so this is where we know that navigation happened for sure.\n    let pendingNavigationEvent = noopAction;\n\n    const stripPositions = <T = any>(el: any, hitTest: boolean): T =>\n      hitTest\n        ? el\n        : (map(keys(el), (key) =>\n            key === \"rect\" ||\n            //key === \"pos\"  Changed so pos is always included.\n            key === \"viewport\"\n              ? del(el, key)\n              : obj(el[key]) &&\n                map(el[key], (item) => stripPositions(item, hitTest))\n          ),\n          el);\n    const trackDocument = (document: Document) => {\n      listen(\n        document,\n        [\"click\", \"contextmenu\", \"auxclick\"],\n        (ev: MouseEvent) => {\n          // Cancel whatever we might be waiting for.\n          pendingNavigationEvent?.(F);\n\n          let trackClicks: boolean | Nullish;\n          let trackRegion: boolean | Nullish;\n          let clickableElement: HTMLElement | null = nil! as HTMLElement; // Typescript insists this is never?\n\n          let nav = F;\n\n          forAncestorsOrSelf<boolean>(ev.target, (el) => {\n            clickableElement ??= isClickable(el) ? el : nil;\n            nav = nav || tagName(el) === \"NAV\";\n\n            let cmp: ConfiguredComponent | ConfiguredComponent[] | Nullish;\n\n            trackClicks ??=\n              trackerFlag(el, \"clicks\", T, (data) => data.track?.clicks) ??\n              ((cmp = getBoundaryData(el)?.component) &&\n                any(cmp, (cmp) => cmp.track?.clicks !== F));\n            trackRegion ??=\n              trackerFlag(el, \"region\", T, (data) => data.track?.region) ??\n              ((cmp = getBoundaryData(el)?.component) &&\n                any(cmp, (cmp) => cmp.track?.region));\n          });\n\n          if (!clickableElement) {\n            return;\n          }\n          const componentContext = getComponentContext(clickableElement);\n          const tags = parseActivationTags(clickableElement);\n          trackClicks ??= !nav;\n          trackRegion ??= T;\n\n          const sharedEventProperties = {\n            ...(trackRegion\n              ? {\n                  pos: getScreenPos(clickableElement, ev),\n                  viewport: getViewport(),\n                }\n              : nil),\n            ...getElementLabel(ev.target, clickableElement),\n            ...componentContext,\n            ...tags,\n            timing: {},\n          };\n\n          if (isLinkElement(clickableElement!)) {\n            const external = clickableElement.hostname !== location.hostname;\n            const { domain, href } = parseDomain(clickableElement.href);\n            if (\n              clickableElement.host === location.host &&\n              clickableElement.pathname === location.pathname &&\n              clickableElement.search === location.search\n            ) {\n              if (clickableElement.hash === \"#\") {\n                // Don't care about that one.\n                return;\n              }\n              if (clickableElement.hash !== location.hash) {\n                push(\n                  tracker,\n                  cast<AnchorNavigationEvent>({\n                    type: \"ANCHOR_NAVIGATION\",\n                    anchor: clickableElement.hash,\n                    ...sharedEventProperties,\n                  })\n                );\n              }\n              return;\n            }\n\n            const navigationEvent: NavigationEvent = cast<NavigationEvent>({\n              id: nextId(),\n              type: \"NAVIGATION\",\n              href: external ? clickableElement.href : href,\n              external,\n              domain,\n              self: T,\n              anchor: clickableElement.hash,\n              ...sharedEventProperties,\n            });\n\n            if (ev.type === \"contextmenu\") {\n              const referrerConsumed = pushNavigationSource(navigationEvent.id);\n\n              const currentUrl = clickableElement.href;\n              const internalUrl = isInternalUrl(currentUrl);\n\n              if (!internalUrl) {\n                if (!trackerConfig.captureContextMenu) return;\n                clickableElement.href = mapUrl(\n                  MNT_URL,\n                  \"=\",\n                  encode(currentUrl)\n                );\n                tryCatch(\n                  () =>\n                    navigator.userActivation?.isActive &&\n                    navigator.clipboard.writeText(currentUrl)\n                );\n              }\n\n              const flag = Date.now();\n              cookies(CONTEXT_MENU_COOKIE, flag, 11000);\n              pollContextCookie(() => {\n                (clickableElement as HTMLAnchorElement).href = currentUrl;\n                if (\n                  !referrerConsumed() ||\n                  +cookies(CONTEXT_MENU_COOKIE)! === flag + 1\n                ) {\n                  cookies(CONTEXT_MENU_COOKIE, nil);\n                  navigationEvent.self = F;\n                  push(tracker, navigationEvent);\n                  clear(pollContextCookie);\n                }\n              }, -100);\n\n              let unbindAll = listen(\n                document,\n                [\"keydown\", \"keyup\", \"visibilitychange\", \"pointermove\"],\n                () =>\n                  unbindAll() &&\n                  clear(pollContextCookie, 10000, () =>\n                    cookies(CONTEXT_MENU_COOKIE, \"\")\n                  )\n              );\n            } else if (ev.button <= 1) {\n              if (\n                ev.button === 1 || //Middle-click: new tab.\n                ev.ctrlKey || // New tab\n                ev.shiftKey || // New window\n                ev.altKey || // Download\n                attr(clickableElement, \"target\") !== window.name\n              ) {\n                pushNavigationSource(navigationEvent.id);\n                navigationEvent.self = F;\n                // Fire immediately, we are staying on the page.\n                push(tracker, navigationEvent);\n                return;\n              } else if (!matchExHash(location.href, clickableElement.href)) {\n                navigationEvent.exit = navigationEvent.external;\n                // No \"real\" navigation will happen if it is only the hash changing.\n                pushNavigationSource(navigationEvent.id);\n              }\n\n              // If it so happened that navigation happened we will send it on VIEW_END.\n              pendingNavigationEvent = registerViewEndAction(() =>\n                push(tracker, navigationEvent)\n              );\n            }\n            return;\n          }\n\n          const cart = tryGetCartEventData(ev.target as Element);\n          (cart || trackClicks) &&\n            push(\n              tracker,\n              cart\n                ? cast<CartUpdatedEvent>({\n                    type: \"CART_UPDATED\",\n                    ...sharedEventProperties,\n                    ...cart,\n                  })\n                : cast<ComponentClickEvent>({\n                    type: \"COMPONENT_CLICK\",\n                    ...sharedEventProperties,\n                  })\n            );\n          return;\n        }\n      );\n    };\n\n    trackDocument(document);\n    onFrame(\n      (frame) => frame.contentDocument && trackDocument(frame.contentDocument)\n    );\n\n    return {\n      decorate(eventData) {\n        if (isViewEndedEvent(eventData)) {\n          pendingNavigationEvent(T);\n        }\n      },\n    };\n  },\n};\n"]}