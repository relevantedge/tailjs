{"version":3,"file":"CommerceExtension.js","sourceRoot":"","sources":["CommerceExtension.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  CartEventData,\n  CommerceData,\n  Content,\n  Order,\n  OrderLine,\n  TrackedEvent,\n  isCartEvent,\n  isOrderCancelledEvent,\n  isOrderEvent,\n} from \"@tailjs/types\";\nimport type { ValidationError, TrackerExtension, NextPatchExtension } from \"..\";\n\nfunction fillPriceDefaults(\n  data: CommerceData,\n  content: Content | null | undefined\n) {\n  if (!content) return data;\n  data.price ??= content.commerce?.price;\n  data.unit ??= content.commerce?.unit;\n  data.currency ??= content.commerce?.unit;\n  return data;\n}\n\nfunction normalizeCartEventData<T extends CartEventData | undefined>(\n  data: T\n): T {\n  if (!data) return undefined!;\n  fillPriceDefaults(data, data.item);\n\n  if (\n    data.units != null &&\n    (data.action == null || data.action === \"add\" || data.action === \"remove\")\n  ) {\n    if (data.units === 0) return undefined!;\n    data.action = data.units > 0 ? \"add\" : \"remove\";\n  }\n  return data;\n}\n\nfunction sum(\n  lines: OrderLine[] | undefined,\n  selector: (line: OrderLine) => number | undefined\n) {\n  let selected: number | undefined;\n  return !lines\n    ? undefined\n    : lines.reduce(\n        (sum, item) =>\n          (selected = selector(item)) != null ? (sum ?? 0) + selected : sum,\n        undefined as number | undefined\n      );\n}\n\nfunction normalizeOrder<T extends Order | undefined>(order: T): T {\n  if (!order) return order;\n  if (Array.isArray(order.items)) {\n    order.items = order.items.map(normalizeOrderLine);\n    if (order.total == null) {\n      order.total = sum(order.items, (line) => line.total);\n    }\n    if (order.vat == null) {\n      order.vat = sum(order.items, (line) => line.vat);\n    }\n  }\n\n  return order;\n}\n\nfunction normalizeOrderLine<T extends OrderLine>(line: T): T {\n  if (!line) return line;\n  fillPriceDefaults(line, line.item);\n  if (line.total == null && line.price != null && line.units != null) {\n    line.total = line.price * line.units;\n  }\n  if (line.price == null && line.total != null && line.units != null) {\n    line.price = line.units !== 0 ? line.total / line.units : 0;\n  }\n\n  return line;\n}\n\nexport class CommerceExtension implements TrackerExtension {\n  public readonly id = \"commerce\";\n\n  patch?(\n    events: TrackedEvent[],\n    next: NextPatchExtension\n  ): Promise<TrackedEvent[]> {\n    return next(\n      events.map((event) =>\n        isOrderEvent(event)\n          ? normalizeOrder(event)\n          : isCartEvent(event)\n          ? normalizeCartEventData(event)\n          : event\n      )\n    );\n  }\n}\n"]}